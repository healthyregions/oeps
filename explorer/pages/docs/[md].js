import Head from "next/head";
import Link from 'next/link';
import { useRouter } from 'next/router'
import styles from "../../styles/Docs.module.css";
import { useState, useEffect } from "react";
import { Gutter } from "../../components/layout/Gutter";
import MainNav from "../../components/layout/MainNav";
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm'
import Footer from "../../components/layout/Footer";
import metadataVariables from '../../meta/metadataVariables.json';

const BASE_DOCS_URL = 'https://raw.githubusercontent.com/healthyregions/oeps/main/metadata/'
const fetchMarkdown = async (url) => await fetch(url).then(r => r.text()).then(r => r.replace('[here](/data_final).', '[here](/download).'))

export default function MarkdownDocs() {
  const router = useRouter()
  const { md } = router.query
  const [markdownText, setMarkdownText] = useState('## Loading...')
  const [theme, setTheme] = useState("")
  const [construct, setConstruct] = useState("")
  const [varList, setVarList] = useState([]);
  const [displayName, setDisplayName] = useState("");

  useEffect(() => {
    if (md !== undefined){
      try {
        fetchMarkdown(`${BASE_DOCS_URL}${md}.md`).then(result => setMarkdownText(result))
        setDisplayName(md.replaceAll("_", " "))
        setTheme(metadataVariables[md]["theme"])
        setConstruct(metadataVariables[md]["construct"])
        setVarList(metadataVariables[md]["variables"])
      } catch(e) {
        setMarkdownText('## Error - Could not locate information.')
      }
    }
  },[md])

  return (
    <div className={styles.container}>
      <Head>
        <title>OEPS Docs :: {displayName}</title>
        <meta name="description" content="Generated by create next app" />
      </Head>
      <MainNav />
      <main className={styles.mdDocMain}>
        <h1 className={styles.title}>
          {displayName}
        </h1>
        <div className={styles.markdownContainer}>
          <div style={{display:'flex', justifyContent:'space-between'}}>
            <Link href='/docs'>&larr; Return to docs</Link>
            <Link href='#variables'>Jump to variables list &darr;</Link>
          </div>
          <p>
            <strong>Theme:</strong> {theme}<br/>
            <strong>Construct:</strong> {construct}
          </p>
          <ReactMarkdown remarkPlugins={[remarkGfm]}>{markdownText}</ReactMarkdown>
        </div>
        <Gutter em={5} />
        <h2 id="variables">
          Key Variables and Definitions
        </h2>
        <p style={{width: "100%"}}>
          <strong>Variable</strong> -- Title of variable<br/>
          <strong>Variable ID</strong> -- Exact name of variable column in datasets<br/>
          <strong>Description</strong> -- Description of variable<br/>
          <strong>Years Available</strong> -- Data for this variable exists for these years<br/>
          <strong>Spatial Scale</strong> -- The variable exists for these levels of spatial scale<br/>
        </p>
        <Gutter em={1} />
        <table className={styles.variableTable} style={{fontSize: '1.25em'}}>
          <thead>
              <tr>
                  <th style={{ width:"20%"}}>Variable</th>
                  <th style={{ width:"10%"}}>Variable ID</th>
                  <th style={{ width:"45%"}}>Description</th>
                  <th style={{ width:"10%"}}>Years Available</th>
                  <th style={{ width:"15%"}}>Spatial Scale</th>
              </tr>
          </thead>
          <tbody>
          {varList.map((variable) => {
              return <tr key={variable['name']}>
                  <td style={{ width:"20%"}}>{variable['title']}</td>
                  <td style={{ width:"10%"}}>{variable['name']}</td>
                  <td style={{ width:"45%"}}>{variable['description']}</td>
                  <td style={{ width:"10%"}}>{variable['years'].join(", ")}</td>
                  <td style={{ width:"15%"}}>{variable['geographies'].join(", ")}</td>
              </tr>
          })}
          </tbody>
        </table>
      </main>
      <Footer />
    </div>
  );
}
